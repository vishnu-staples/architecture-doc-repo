# Notification Model

The Notification model represents CloudEvents messages used throughout the FTS platform for event communication.

## Source File
`FileTransferCommon/FileTransferCommon/Model/Notification.cs`

## Schema

```csharp
public class Notification
{
    public string specversion { get; set; }
    public string type { get; set; }
    public string source { get; set; }
    public string subject { get; set; }
    public string id { get; set; }
    public string time { get; set; }
    public string dataschema { get; set; }
    public DataInfo data { get; set; }
}

public class DataInfo
{
    public string correlationId { get; set; }
    public string instanceId { get; set; }
    public string clientIpAddress { get; set; }
    public string accountId { get; set; }
    public string errorCode { get; set; }
    public string errorTitle { get; set; }
    public string errorMsg { get; set; }
    public string fileName { get; set; }
    public string targetFileName { get; set; }
    public long fileSize { get; set; }
    public string sourceFileName { get; set; }
    public List<string> parameters { get; set; }
}
```

## Field Descriptions

### Notification (Root)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `specversion` | string | Yes | CloudEvents specification version (always `"1.0"`) |
| `type` | string | Yes | Event type (e.g., `"Succeeded"`, `"Error"`) |
| `source` | string | Yes | Event source identifier (e.g., `"FTP.File.ExternalService"`) |
| `subject` | string | Yes | Event subject/category (e.g., `"File Upload"`) |
| `id` | string | Yes | Unique event identifier (UUID) |
| `time` | string | Yes | ISO 8601 timestamp (`"2024-01-15T10:30:00+0000"`) |
| `dataschema` | string | No | Data schema version (typically `"1.0"`) |
| `data` | DataInfo | Yes | Event payload |

### DataInfo (Payload)

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `correlationId` | string | No | Correlation ID for request tracing |
| `instanceId` | string | No | Processing instance identifier |
| `clientIpAddress` | string | No | Client IP address |
| `accountId` | string | Yes | Account identifier for routing |
| `errorCode` | string | No | Error code (for error events) |
| `errorTitle` | string | No | Error title |
| `errorMsg` | string | No | Detailed error message |
| `fileName` | string | No | Source file path |
| `targetFileName` | string | No | Target/destination file path |
| `fileSize` | long | No | File size in bytes |
| `sourceFileName` | string | No | Original source filename |
| `parameters` | List\<string\> | No | Additional parameters |

## JSON Serialization

Fields with null values are omitted from JSON output:

```csharp
[JsonProperty(NullValueHandling = NullValueHandling.Ignore)]
public string correlationId { get; set; }
```

## Example Messages

### Success Event (File Upload)

```json
{
  "specversion": "1.0",
  "type": "Succeeded",
  "source": "FTP.File.ExternalService",
  "subject": "File Upload",
  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "time": "2024-01-15T10:30:00+0000",
  "dataschema": "1.0",
  "data": {
    "correlationId": "corr-123456",
    "accountId": "ACCOUNT001",
    "fileName": "incoming/data.csv",
    "targetFileName": "processed/data.csv",
    "fileSize": 1048576
  }
}
```

### Error Event

```json
{
  "specversion": "1.0",
  "type": "Error",
  "source": "FTS.JobHandler",
  "subject": "JobSettingRead",
  "id": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
  "time": "2024-01-15T10:35:00+0000",
  "dataschema": "1.0",
  "data": {
    "correlationId": "corr-123456",
    "accountId": "ACCOUNT001",
    "errorCode": "CONFIG_NOT_FOUND",
    "errorTitle": "Exception",
    "errorMsg": "Could not find jobsettings.json for path: /mnt/jobconfig/..."
  }
}
```

### FireEvent Output

Generated by the `FireEvent` action:

```json
{
  "specversion": "1.0",
  "type": "Succeeded",
  "source": "FTS.JobHandler",
  "subject": "File Ready",
  "id": "c3d4e5f6-a7b8-9012-cdef-345678901234",
  "time": "2024-01-15T10:40:00+0000",
  "data": {
    "correlationId": "corr-123456",
    "accountId": "ACCOUNT001",
    "fileName": "output/processed_file.csv",
    "fileSize": 524288
  }
}
```

## Validation Rules

The FileEventHandler validates incoming notifications:

1. **Required Fields**: `type`, `source`, `subject`, `data.accountId` must be non-empty
2. **JSON Format**: Must be valid JSON
3. **Field Presence**: All required fields must exist

```csharp
// From MessageHandler.cs
if (string.IsNullOrEmpty(Notify.type) ||
    string.IsNullOrEmpty(Notify.subject) ||
    string.IsNullOrEmpty(Notify.source) ||
    string.IsNullOrEmpty(Notify.data.accountId))
{
    Logger.Warning($"Garbage message: Type,Subject,Source,AccountID not provided");
    return null;
}
```

## Default Values (from appsettings)

```json
{
  "Notification": {
    "Specversion": "1.0",
    "Type_Error": "Error",
    "Type_Success": "Succeeded",
    "Source": "FTP.File.ExternalService",
    "Dataschema": "1.0",
    "Subject": {
      "JobSettingRead": "JobSettingRead",
      "JobSecretRead": "JobSecretRead"
    },
    "ErrorTitle": {
      "Exception": "Exception"
    }
  }
}
```

## Usage Patterns

### Creating Notifications

```csharp
var notification = new Notification
{
    specversion = "1.0",
    type = "Succeeded",
    source = "FTS.JobHandler",
    subject = "File Processed",
    id = Guid.NewGuid().ToString(),
    time = DateTime.UtcNow.ToString("yyyy-MM-ddThh:mm:ss+0000"),
    data = new Notification.DataInfo
    {
        correlationId = existingCorrelationId,
        accountId = accountId,
        fileName = outputFileName,
        fileSize = fileContent.Length
    }
};
```

### Deserializing Events

```csharp
Notification notify = JsonConvert.DeserializeObject<Notification>(messageData);
```

## Field Name Mapping

Different contexts use different casing conventions for the same fields:

| CloudEvent Field | Placeholder | Azure Table Field | Notes |
|------------------|-------------|-------------------|-------|
| `data.accountId` | `{@Message.accountID}` | `AccountID` | Account identifier |
| `data.correlationId` | `{@Message.correlationId}` | `CorrelationID` | Correlation tracking |
| `data.fileName` | `{@Message.fileName}` | `FileName` | File path |
| `source` | `{@Message.source}` | `EventSource` | Event source |
| `subject` | `{@Message.subject}` | `EventSubject` | Event subject |
| `type` | `{@Message.type}` | `EventType` | Event type |

> **Important**: When using placeholders in job configurations, use the exact casing shown in the "Placeholder" column (e.g., `{@Message.accountID}` not `{@Message.accountId}`).

## Related Documentation

- [Event-Driven Architecture](../architecture/event-driven-architecture.md)
- [Job ConfigModel](./job-config-model.md)
- [Action Types - FireEvent](../job-configuration/action-types.md#fireevent)
